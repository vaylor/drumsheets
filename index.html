# .github/workflows/sync-to-public.yml
# This version uses Personal Access Token (never expires)

name: Sync PDFs to Public Repository

on:
  push:
    branches: [ main ]
    paths:
      - '**.pdf'
      - '**.tex'
      - '**.ly'
  workflow_dispatch: # Allows manual trigger

jobs:
  sync-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout private repo
      uses: actions/checkout@v3
      with:
        path: private

    - name: Checkout public repo
      uses: actions/checkout@v3
      with:
        repository: vaylor/drumsheets-public
        token: ${{ secrets.PUBLIC_REPO_TOKEN }}
        path: public

    - name: Copy PDFs to public repo
      run: |
        # Remove old PDF folder from public repo
        rm -rf public/PDF
        
        # Copy entire PDF folder structure to public repo
        if [ -d "private/PDF" ]; then
          echo "Copying PDF folder from private to public repo..."
          cp -r private/PDF public/
          
          # List what was copied
          echo "Copied PDFs:"
          find public/PDF -name "*.pdf" -type f | while read pdf; do
            echo "  - $pdf"
          done
          
          # Show summary
          pdf_count=$(find public/PDF -name "*.pdf" -type f | wc -l)
          echo "Total PDFs copied: $pdf_count"
        else
          echo "ERROR: No PDF folder found in private repo!"
          echo "Contents of private repo:"
          ls -la private/
          exit 1
        fi

    - name: Generate index.html
      run: |
        cd public
        
        # Create index.html with embedded CSS and JS
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Eric's Drum Sheets Library</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: linear-gradient(135deg, #003087 0%, #0055bc 100%);
                    min-height: 100vh;
                    padding: 20px;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                }
                h1 {
                    color: white;
                    text-align: center;
                    margin-bottom: 10px;
                    font-size: 2.5em;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                }
                .subtitle {
                    color: rgba(255,255,255,0.9);
                    text-align: center;
                    margin-bottom: 30px;
                    font-size: 1.1em;
                }
                .search-box {
                    width: 100%;
                    max-width: 500px;
                    margin: 0 auto 30px;
                    display: block;
                    padding: 15px 20px;
                    font-size: 16px;
                    border: none;
                    border-radius: 50px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                }
                .sheets-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                    gap: 20px;
                    margin-bottom: 30px;
                }
                .sheet-card {
                    background: white;
                    border-radius: 15px;
                    padding: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                    border-top: 3px solid #003087;
                }
                .sheet-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
                }
                .sheet-icon {
                    font-size: 2em;
                    margin-bottom: 10px;
                }
                .sheet-title {
                    font-size: 1.1em;
                    font-weight: 600;
                    margin-bottom: 8px;
                    color: #333;
                    word-break: break-word;
                }
                .sheet-class {
                    font-size: 0.9em;
                    color: #666;
                    margin-bottom: 12px;
                    font-style: italic;
                }
                .sheet-actions {
                    display: flex;
                    gap: 8px;
                }
                .btn {
                    flex: 1;
                    padding: 10px;
                    text-decoration: none;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    transition: all 0.2s;
                    cursor: pointer;
                    border: none;
                    text-align: center;
                }
                .btn-view {
                    background: #003087;
                    color: white;
                }
                .btn-view:hover {
                    background: #0055bc;
                }
                .btn-download {
                    background: #f0f0f0;
                    color: #333;
                }
                .btn-download:hover {
                    background: #e0e0e0;
                }
                .btn:hover {
                    transform: scale(1.05);
                }
                .stats {
                    text-align: center;
                    color: white;
                    margin-top: 40px;
                    padding: 20px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 15px;
                    backdrop-filter: blur(10px);
                }
                .no-results {
                    text-align: center;
                    color: white;
                    font-size: 1.2em;
                    margin-top: 50px;
                    display: none;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ü•Å Eric's Drum Sheets Library</h1>
                <p class="subtitle">Professional Drum Education Materials</p>
                
                <input type="text" 
                       class="search-box" 
                       id="searchBox" 
                       placeholder="Search sheets... (e.g., 'jazz', 'basic beats', 'fills')">
                
                <div class="sheets-grid" id="sheetsGrid">
                    <!-- PDF cards will be inserted here by JavaScript -->
                </div>
                
                <div class="no-results" id="noResults">
                    No sheets found matching your search. Try different keywords!
                </div>
                
                <div class="stats">
                    <span id="sheetCount">0</span> drum sheets available | 
                    Last updated: <span id="updateTime"></span>
                </div>
            </div>
            
            <script>
                // PDF files data will be inserted here by the bash script
                const pdfFiles = [
                    // PLACEHOLDER_FOR_PDF_DATA
                ];
                
                // Generate cards
                const grid = document.getElementById('sheetsGrid');
                const sheetCount = document.getElementById('sheetCount');
                const updateTime = document.getElementById('updateTime');
                const noResults = document.getElementById('noResults');
                
                // Set update time
                updateTime.textContent = new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                // Set count
                sheetCount.textContent = pdfFiles.length;
                
                // Create cards
                pdfFiles.forEach(pdf => {
                    const card = document.createElement('div');
                    card.className = 'sheet-card';
                    card.dataset.name = pdf.name.toLowerCase();
                    
                    card.innerHTML = `
                        <div class="sheet-icon">üìÑ</div>
                        <div class="sheet-title">${pdf.name}</div>
                        <div class="sheet-class">Class: ${pdf.className || 'General'}</div>
                        <div class="sheet-actions">
                            <a href="${pdf.path}" target="_blank" class="btn btn-view">View</a>
                            <a href="${pdf.path}" download class="btn btn-download">Download</a>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
                
                // Search functionality
                const searchBox = document.getElementById('searchBox');
                const cards = document.querySelectorAll('.sheet-card');
                
                searchBox.addEventListener('input', (e) => {
                    const search = e.target.value.toLowerCase();
                    let hasResults = false;
                    
                    cards.forEach(card => {
                        const name = card.dataset.name;
                        if (name.includes(search)) {
                            card.style.display = 'block';
                            hasResults = true;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    noResults.style.display = hasResults ? 'none' : 'block';
                });
            </script>
        </body>
        </html>
        EOF
        
        # Now insert the PDF data into the HTML
        echo "Generating PDF list..."
        
        # Create a temporary file for the PDF array
        echo "const pdfFiles = [" > pdf_data.js
        
        # Find all PDFs in the PDF folder and add them to the array
        first=true
        find PDF -name "*.pdf" -type f 2>/dev/null | sort | while read pdf; do
          # Get the path, name, and class
          path=${pdf}
          name=$(basename "$pdf" .pdf)
          # Extract class name from path (PDF/ClassName/file.pdf)
          className=$(echo "$pdf" | cut -d'/' -f2)
          
          if [ "$first" = true ]; then
            first=false
          else
            echo "," >> pdf_data.js
          fi
          
          echo -n "  {name: '${name}', path: '${path}', className: '${className}'}" >> pdf_data.js
        done
        
        echo "" >> pdf_data.js
        echo "];" >> pdf_data.js
        
        # Replace the placeholder in the HTML with actual data
        sed -i '/\/\/ PLACEHOLDER_FOR_PDF_DATA/r pdf_data.js' index.html
        sed -i '/\/\/ PLACEHOLDER_FOR_PDF_DATA/d' index.html
        
        # Clean up
        rm pdf_data.js
        
        echo "Generated index.html with $(find PDF -name "*.pdf" -type f 2>/dev/null | wc -l) PDFs"

    - name: Commit and push to public repo
      run: |
        cd public
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        git add .
        git commit -m "Update PDFs from private repository - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push
